<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CAN Register Evaluator</title>
  <!-- <link rel="manifest" href="manifest.json" /> -->
  <link rel="stylesheet" href="../styles.css" />
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <script data-goatcounter="https://can.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</head>

<body>

  <div id="site-menu"></div>
  <script type="module" src="/can/menu.js"></script>

  <main>

    <div class="page-header">
      <h1>CAN Register Evaluator</h1>
      <h1><a href="#" id="openHelp" class="help-link" aria-haspopup="dialog" aria-controls="helpModal">Help</a></h1>

    </div>

    <!-- Responsive container for 3-column layout -->
    <div class="responsive-container">

      <!-- Column 1: Settings -->
      <div class="column settings-column">
        <h3>CAN Clock settings</h3>
        <table id="ClockSettingsTable">
          <thead>
            <tr>
              <th></th>
              <th>Value</th>
              <th>Unit</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Frequency</td>
              <td><input type="number" id="par_clk_freq" class="input-field" /></td>
              <td>MHz</td>
            </tr>
            <tr>
              <td>Clock period</td>
              <td><input type="text" id="res_clk_period" class="result-field" readonly /></td>
              <td>ns</td>
            </tr>
          </tbody>
        </table>

        <h3>CAN Bit Timing</h3>
        <!-- Bit Timing Drawing -->
        <svg id="DrawingBTArb" width="342" height="60"></svg>
        <svg id="DrawingBTFDdata" width="342" height="60"></svg>
        <svg id="DrawingBTXLdata" width="342" height="60"></svg>
        <svg id="DrawingBTXLdataPWM" width="342" height="60"></svg>

        <!-- widht of legend set in JavaScript -->
        <div id="DrawingBTLegend" class="legend">
          <div class="legend-item"><span class="legend-color" style="background:#555555"></span>SyncSeg</div>
          <div class="legend-item"><span class="legend-color" style="background:#FFD000"></span>PropSeg</div>
          <div class="legend-item"><span class="legend-color" style="background:#4CAF50"></span>PhaseSeg1</div>
          <div class="legend-item"><span class="legend-color" style="background:#2196F3"></span>PhaseSeg2</div>
          <br>
          <div class="legend-item"><span class="legend-color" style="background:#FF0000"></span>SP</div>
          <div class="legend-item"><span class="legend-color" style="background:#800080"></span>SSP Offset</div>
          <div class="legend-item"><span class="legend-color" style="background:#999999"></span>SJW</div>
        </div>

        <!-- Bit Timing Parameters Table -->
        <table id="BitTimingTable">
          <thead>
            <tr>
              <th colspan="4" class="headline_in_table">Bit Timing Properties</th>
            </tr>
            <tr>
              <th></th>
              <th>Arb.<br>phase</th>
              <th>FD Data<br>phase</th>
              <th>XL Data<br>phase</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Bit-rate [Mbit/s]</td>
              <td><input type="text" id="res_bitrate_arb" class="result-field" readonly /></td>
              <td><input type="text" id="res_bitrate_datfd" class="result-field" readonly /></td>
              <td><input type="text" id="res_bitrate_datxl" class="result-field" readonly /></td>
            </tr>
            <tr>
              <td>SP [%]</td>
              <td><input type="text" id="res_sp_arb" class="result-field" readonly /></td>
              <td><input type="text" id="res_sp_datfd" class="result-field" readonly /></td>
              <td><input type="text" id="res_sp_datxl" class="result-field" readonly /></td>
            </tr>
            <tr>
              <td>SSP [%]</td>
              <td>---</td>
              <td><input type="text" id="res_ssp_datfd" class="result-field" readonly /></td>
              <td><input type="text" id="res_ssp_datxl" class="result-field" readonly /></td>
            </tr>
            <tr>
              <td>tq per bit time</td>
              <td><input type="text" id="res_tqperbit_arb" class="result-field" readonly /></td>
              <td><input type="text" id="res_tqperbit_datfd" class="result-field" readonly /></td>
              <td><input type="text" id="res_tqperbit_datxl" class="result-field" readonly /></td>
            </tr>
            <tr>
              <td>tq length [ns]</td>
              <td><input type="text" id="res_tqlen_arb" class="result-field" readonly /></td>
              <td><input type="text" id="res_tqlen_datfd" class="result-field" readonly /></td>
              <td><input type="text" id="res_tqlen_datxl" class="result-field" readonly /></td>
            </tr>
            <tr>
              <td>Bit length [ns]</td>
              <td><input type="text" id="res_bitlength_arb" class="result-field" readonly /></td>
              <td><input type="text" id="res_bitlength_datfd" class="result-field" readonly /></td>
              <td><input type="text" id="res_bitlength_datxl" class="result-field" readonly /></td>
            </tr>
          </tbody>
          <thead>
            <tr>
              <th colspan="4" class="headline_in_table">Bit Timing Settings</th>
            </tr>
            <tr>
              <th></th>
              <th>Arb.</th>
              <th>FD Data</th>
              <th>XL Data</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>BRP</td>
              <td><input type="text" id="par_brp_arb" class="input-field" readonly /></td>
              <td><input type="text" id="par_brp_datfd" class="input-field" readonly /></td>
              <td><input type="text" id="par_brp_datxl" class="input-field" readonly /></td>
            </tr>
            <tr>
              <td>Prop+PhaseSeg1</td>
              <td><input type="text" id="par_prop_and_phaseseg1_arb" class="input-field" readonly /></td>
              <td><input type="text" id="par_prop_and_phaseseg1_datfd" class="input-field" readonly /></td>
              <td><input type="text" id="par_prop_and_phaseseg1_datxl" class="input-field" readonly /></td>
            </tr>
            <tr>
              <td>PhaseSeg2</td>
              <td><input type="text" id="par_phaseseg2_arb" class="input-field" readonly /></td>
              <td><input type="text" id="par_phaseseg2_datfd" class="input-field" readonly /></td>
              <td><input type="text" id="par_phaseseg2_datxl" class="input-field" readonly /></td>
            </tr>
            <tr>
              <td>SJW</td>
              <td><input type="text" id="par_sjw_arb" class="input-field" readonly /></td>
              <td><input type="text" id="par_sjw_datfd" class="input-field" readonly /></td>
              <td><input type="text" id="par_sjw_datxl" class="input-field" readonly /></td>
            </tr>
            <tr>
              <td>TDC</td>
              <td>---</td>
              <td colspan="2" class="table_colspan_center"><input type="checkbox" id="par_tdc_datfdxl"
                  class="input-field" disabled /></td>
            </tr>
            <tr>
              <td>SSP Offset</td>
              <td>---</td>
              <td><input type="text" id="par_sspoffset_datfd" class="input-field" readonly /></td>
              <td><input type="text" id="par_sspoffset_datxl" class="input-field" readonly /></td>
            </tr>
            <tr>
              <td>TMS</td>
              <td>---</td>
              <td>---</td>
              <td><input type="checkbox" id="par_tms_datxl" class="input-field" disabled /></td>
            </tr>
          </tbody>
          <thead>
            <tr>
              <th colspan="4" class="headline_in_table">PWM Settings</th>
            </tr>
            <tr>
              <th></th>
              <th>Arb.</th>
              <th>FD Data</th>
              <th>XL Data</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>PWMO</td>
              <td>---</td>
              <td>---</td>
              <td><input type="text" id="par_pwmo" class="input-field" readonly /></td>
            </tr>
            <tr>
              <td>PWMS</td>
              <td>---</td>
              <td>---</td>
              <td><input type="text" id="par_pwms" class="input-field" readonly /></td>
            </tr>
            <tr>
              <td>PWML</td>
              <td>---</td>
              <td>---</td>
              <td><input type="text" id="par_pwml" class="input-field" readonly /></td>
            </tr>
          </tbody>
          <thead>
            <tr>
              <th colspan="4" class="headline_in_table">PWM Properties</th>
            </tr>
            <tr>
              <th></th>
              <th>Arb.</th>
              <th>FD Data</th>
              <th>XL Data</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>PWM length [ns]</td>
              <td>---</td>
              <td>---</td>
              <td><input type="text" id="res_pwm_symbol_len_ns_datxl" class="result-field" readonly /></td>
            </tr>
            <tr>
              <td>PWM length [clk]</td>
              <td>---</td>
              <td>---</td>
              <td><input type="text" id="res_pwm_symbol_len_clk_cycles_datxl" class="result-field" readonly /></td>
            </tr>
            <tr>
              <td>PWMs per bit</td>
              <td>---</td>
              <td>---</td>
              <td><input type="text" id="res_pwm_symbols_per_bit_time_datxl" class="result-field" readonly /></td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Column 2: Register Values -->
      <div class="column register-column">
        <h3>Register Values</h3>
        <label for="canIpModuleSelect">CAN Module</label>
        <div class="select-button-row">
          <select id="canIpModuleSelect" class="styled-select">
            <option value="M_CAN">M_CAN</option>
            <option value="X_CAN">X_CAN</option>
            <option value="XS_CAN" selected>XS_CAN</option>
            <option value="X_CANB">X_CANB</option>
            <!-- <option value="XS_CAN">XS_CAN</option> -->
          </select>
          <button type="button" id="loadRegisterValuesExampleButton" class="styled-button">load example</button>
        </div>
        <button type="button" id="processRegisterValuesButton" class="styled-button">process register values</button>
        <textarea id="userInputRegisterValues" class="register-textarea" placeholder="Enter your register values (memory dump) here.

=== Required format ==========
0xADDR<space>0xVALUE
- 0xADDR is a hex value,
  can be local or global
  (e.g. 12, 32, or 64 bit address)
- 0xVALUE is a hex value,
  only 32 LSBit decoded,

MSBit is on the left, LSB on the right

Values are interpreted as hex values, even if leading '0x' is missing.

Comments: lines starting with '#' are ignored

Reserved Addresses: Memory dump can contain also reserved addresses. They will be detected and ignored.

=== Example ==================
# This is a comment
0x004 0x87654321
0x008 0x000F0104

=== Hints ===
1. Create a memory dump of the complete CAN module address space.
2. Load example memory via button
"></textarea>
      </div>

      <!-- Column 3: Validation Report -->
      <div class="column report-column">
        <h3 class="report-headline">Evaluation Report
          <div class="inline-control" role="group" aria-label="Report filters">
            <input type="checkbox" id="par_report_info" checked /> info
            <input type="checkbox" id="par_report_infoVerbose" /> info verbose
            <input type="checkbox" id="par_report_infoHighlighted" checked /> info bold&amp;calc
            <!--<input type="checkbox" id="par_report_calculation" checked/> calculation-->
            <!--<input type="checkbox" id="par_report_recommendation" checked/> recommendation-->
            <input type="checkbox" id="par_report_warning" checked /> warning
            <input type="checkbox" id="par_report_error" checked /> error

          </div>
        </h3>
        <pre id="reportTextArea" class="register-textarea report-textarea" readonly>The "Register evaluations report" will appear here after processing ...

=== HOW TO USE THIS REGISTER EVALUTOR? ========================
Step 1:  Set the "CAN clock frequency" (e.g. 160 MHz for CAN XL, 80 MHz for CAN FD).
Step 2:  Select the CAN Module (drop down field, also refered to as CAN Controller)
Step 2a: Copy the memory dump of your CAN Module to "Register Values" text area.
Step 2b: Alternatively, load example memory dump for your selected CAN Module.
Step 3:  Press button "process register values" to generate the evaluation report.
    </pre>
      </div>

    </div>

    <!-- load JavaScript file(s); type=module means loading is possible in .js files itself -->
    <script type="module" src="script_main.js"></script>

    <!-- Help Modal -->
    <div id="helpModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true"
      aria-labelledby="helpTitle">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="helpTitle">Help: How to use the CAN Register Evaluator?</h2>
          <button type="button" id="closeHelp" class="modal-close" aria-label="Close">Close</button>
        </div>
        <div class="modal-body">
          <p>This tool analyzes your CAN Module/Controller register dump and highlights configuration issues. Most
            issues are
            related to incorrect or suboptimal register settings.</p>
          <h3>Step by Step</h3>
          <ol>
            <li>Create a memory dump of your CAN Controller/Module memory space (e.g. by using the printf() command or
              with help of a debugger). The dump must have the format: 0xADDR <space> 0xVALUE. You can have a look on
                exemplary memory dumps by clicking the "load example" button.</li>
            <li>Paste your register dump to the "Register Values" text area.</li>
            <li>Select your CAN Module from the drop down list (e.g., XS_CAN, X_CAN, M_CAN, ...).</li>
            <li>Set the CAN clock frequency in "CAN Clock settings". This has only an impact on the calcuated bit rates.
            </li>
            <li>Press button "process register values" to generate the report. Done</li>
          </ol>
          <p>The report pane shows info, warnings, and errors. Use the checkboxes in the report header to filter
            visibility.</p>
          <p>All bit timing properties are additionally visualized graphically and as a table on the left under "CAN Bit
            Timing".</p>
          <h3>Quick Try</h3>
          <p>Press the "load example" button to load an example register dump for the selected CAN Module. Then press
            "process register values" to see how the report looks like.</p>
          <p>Enjoy!</p>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const openBtn = document.getElementById('openHelp');
        const modal = document.getElementById('helpModal');
        const closeBtn = document.getElementById('closeHelp');
        function openModal(e) {
          if (e) e.preventDefault();
          modal.classList.add('open');
          modal.setAttribute('aria-hidden', 'false');
        }
        function closeModal() {
          modal.classList.remove('open');
          modal.setAttribute('aria-hidden', 'true');
        }
        openBtn.addEventListener('click', openModal);
        closeBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', function (e) { if (e.target === modal) closeModal(); });
        document.addEventListener('keydown', function (e) { if (e.key === 'Escape') closeModal(); });
      })();
    </script>

  </main>

  <div id="site-footer"></div>
  <script type="module" src="/can/footer.js"></script>

</body>

</html>